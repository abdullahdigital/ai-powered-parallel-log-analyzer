---
---

<section class="ai-rule-generation-section">
  <div class="section-header">
    <div class="section-title">AI-ASSISTED RULE GENERATION</div>
  </div>

  <div class="ai-input-area">
    <label for="natural-language-rule">Describe your rule in natural language:</label>
    <textarea id="natural-language-rule" rows="5" placeholder="e.g., 'Detect multiple failed login attempts from the same IP within 5 minutes.'"></textarea>
    <button class="action-btn primary" id="generate-rule-btn">
      <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5a3 3 0 1 0-3 3"></path>
        <path d="M12 5a3 3 0 1 1 3 3"></path>
        <path d="M12 7a6 6 0 0 1 6 6v3a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2v-1a2 2 0 0 0-2-2 1 1 0 0 1-1-1V7a3 3 0 0 0-3-3H8a3 3 0 0 0-3 3v1a1 1 0 0 1-1 1 2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2v-3a6 6 0 0 1 6-6z"></path>
      </svg>
      Generate Rule
    </button>
  </div>

  <div class="ai-output-area">
    <label for="generated-json-rule">AI-Generated JSON Rule (Review and Approve):</label>
    <textarea id="generated-json-rule" rows="10" readonly placeholder="AI-generated rule will appear here..."></textarea>
    <div class="ai-actions">
      <button class="action-btn secondary" id="clear-rule-btn">
        <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        Clear
      </button>
      <button class="action-btn primary" id="approve-rule-btn">
        <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 11 12 14 22 4"></polyline>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
        Approve & Add Rule
      </button>
    </div>
  </div>
</section>

<style>
  /* Styles for AITextToRule component */
  .ai-rule-generation-section {
    background-color: var(--card-bg);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
  }

  .section-header {
    margin-bottom: 25px;
  }

  .section-title {
    font-size: 18px;
    font-weight: 600;
  }

  .ai-input-area,
  .ai-output-area {
    margin-bottom: 20px;
  }

  .ai-input-area label,
  .ai-output-area label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 10px;
    color: var(--text-secondary);
  }

  .ai-input-area textarea,
  .ai-output-area textarea {
    width: 100%;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: var(--text-primary);
    resize: vertical;
    margin-bottom: 15px;
  }

  .ai-output-area textarea {
    background-color: rgba(0, 123, 255, 0.05); /* Slightly different background for output */
  }

  .action-btn {
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--card-bg);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
  }

  .action-btn.primary {
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    border: none;
    color: white;
  }

  .action-btn.secondary {
    background-color: rgba(255, 255, 255, 0.05);
  }

  .action-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .action-btn-icon {
    width: 18px;
    height: 18px;
  }

  .ai-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
</style>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const generateBtn = document.getElementById('generate-rule-btn');
    const clearBtn = document.getElementById('clear-rule-btn');
    const approveBtn = document.getElementById('approve-rule-btn');
    const inputArea = document.getElementById('natural-language-rule');
    const outputArea = document.getElementById('generated-json-rule');

    let currentGeneratedRule = null;

    if (generateBtn) {
      generateBtn.addEventListener('click', async () => {
        const description = inputArea.value.trim();
        if (!description) {
          alert('Please enter a rule description.');
          return;
        }

        const originalText = generateBtn.innerHTML;
        generateBtn.innerHTML = `
          <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
          </svg>
          Generating...
        `;
        generateBtn.disabled = true;

        try {
          const response = await fetch('http://127.0.0.1:8080/api/ai/generate-rule', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ description }),
          });

          if (response.ok) {
            const rule = await response.json();
            currentGeneratedRule = rule;
            outputArea.value = JSON.stringify(rule, null, 2);
          } else {
            const errorText = await response.text();
            console.error('Rule generation failed:', response.status, errorText);
            alert(`Rule generation failed: ${errorText}`);
          }
        } catch (error) {
          console.error('Error during rule generation:', error);
          alert('Error during rule generation.');
        } finally {
          generateBtn.innerHTML = originalText;
          generateBtn.disabled = false;
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        inputArea.value = '';
        outputArea.value = '';
        currentGeneratedRule = null;
      });
    }

    if (approveBtn) {
      approveBtn.addEventListener('click', async () => {
        if (!outputArea.value.trim()) {
          alert('No rule to approve. Please generate a rule first.');
          return;
        }

        try {
          let ruleToApprove;
          try {
            ruleToApprove = JSON.parse(outputArea.value);
          } catch (e) {
            alert('Invalid JSON in output area. Please correct it before approving.');
            return;
          }

          const response = await fetch('http://127.0.0.1:8080/api/rules/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(ruleToApprove),
          });

          if (response.ok) {
            alert('Rule approved and added successfully!');
            // Optionally clear or switch to rules view
            outputArea.value = '';
            inputArea.value = '';
          } else {
            const errorText = await response.text();
            console.error('Failed to add rule:', response.status, errorText);
            alert(`Failed to add rule: ${errorText}`);
          }
        } catch (error) {
          console.error('Error adding rule:', error);
          alert('Error adding rule.');
        }
      });
    }
  });
</script>
