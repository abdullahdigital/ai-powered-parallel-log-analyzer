---
import './ThreatDetections.css';
---

<section class="live-feed-section">
  <div class="feed-header">
    <div class="feed-title">GENERATED ALERTS</div>
    <div class="feed-status">
      <div class="alert-count" id="total-alerts-count">0</div>
      <span>TOTAL</span>
    </div>
  </div>
  <div class="feed-content">
    <table class="alerts-table">
      <thead>
        <tr>
          <th></th>
          <th>TIME</th>
          <th>SEVERITY</th>
          <th>MESSAGE</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody id="alerts-table-body">
        <!-- Alert rows will be injected here by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Modal for Raw Log Data -->
  <div id="raw-log-modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Raw Log Data</h2>
      <pre id="raw-log-display"></pre>
    </div>
  </div>
</section>

<script>
  // Function to render alerts into the table
  const renderAlerts = (alerts) => {
    const alertsTableBody = document.getElementById('alerts-table-body');
    const totalAlertsCount = document.getElementById('total-alerts-count');
    
    if (!alertsTableBody || !totalAlertsCount) return;
    
    if (!alerts || alerts.length === 0) {
      alertsTableBody.innerHTML = '<tr><td colspan="5" class="no-alerts-msg">No alerts detected in last run.</td></tr>';
      totalAlertsCount.textContent = '0';
      return;
    }

    alertsTableBody.innerHTML = '';
    alerts.forEach(alert => {
      const time = new Date(alert.timestamp).toLocaleTimeString();
      const severity = typeof alert.alert_type === 'string' ? alert.alert_type : Object.keys(alert.alert_type)[0];
      const severityClass = severity.toLowerCase();

      const row = document.createElement('tr');
      row.classList.add('alert-row');
      row.innerHTML = `
        <td class="expand-toggle"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></td>
        <td>${time}</td>
        <td><span class="severity-badge ${severityClass}">${severity}</span></td>
        <td>${alert.description}</td>
        <td><button class="view-raw-btn" data-raw-log="${(alert.log_entry_sample?.raw_log || 'N/A').replace(/"/g, '&quot;')}">View Raw</button></td>
      `;
      alertsTableBody.appendChild(row);

      const expandableRow = document.createElement('tr');
      expandableRow.classList.add('expandable-content');
      expandableRow.innerHTML = `
        <td colspan="5">
          <div class="expanded-details">
            <div class="details-grid">
              <div class="details-column">
                <p><strong>ID:</strong> ${alert.id}</p>
                <p><strong>IP Address:</strong> ${alert.log_entry_sample?.ip_address || 'Unknown'}</p>
              </div>
              <div class="details-column">
                <p><strong>User ID:</strong> ${alert.log_entry_sample?.user_id || 'System'}</p>
                <p><strong>Event Type:</strong> ${alert.log_entry_sample?.event_type || 'Generic'}</p>
              </div>
            </div>
            
            <div class="ai-explanation-area" id="ai-area-${alert.id}">
              <button class="ai-explain-btn" data-alert-id="${alert.id}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                Explain with Security AI
              </button>
              <div class="ai-response" style="display: none;">
                <div class="ai-loading"><div class="spinner"></div> Analyzing threat vectors...</div>
                <div class="ai-text"></div>
              </div>
            </div>
          </div>
        </td>
      `;
      alertsTableBody.appendChild(expandableRow);
    });
    totalAlertsCount.textContent = alerts.length;
    
    // Store alerts locally for AI explainer to access
    window.currentAlerts = alerts;
  };

  document.addEventListener('DOMContentLoaded', () => {
    const alertsTableBody = document.getElementById('alerts-table-body');
    const totalAlertsCount = document.getElementById('total-alerts-count');
    const rawLogModal = document.getElementById('raw-log-modal');
    const closeModalButton = rawLogModal?.querySelector('.close-button');
    const rawLogDisplay = document.getElementById('raw-log-display');

    if (!alertsTableBody || !totalAlertsCount) return;

    // Listen for real alerts from the analysis engine
    document.addEventListener('alertsDetected', (event) => {
      const alerts = event.detail.alerts;
      renderAlerts(alerts);
    });

    // Event listener for expandable rows, modal, and AI explain button
    alertsTableBody.addEventListener('click', async (event) => {
      const target = event.target;
      
      // AI Explain Button logic
      if (target.classList.contains('ai-explain-btn') || target.closest('.ai-explain-btn')) {
        const btn = target.classList.contains('ai-explain-btn') ? target : target.closest('.ai-explain-btn');
        const alertId = btn.dataset.alertId;
        const alert = window.currentAlerts.find(a => a.id === alertId);
        
        if (!alert) return;
        
        const area = btn.closest('.ai-explanation-area');
        const responseDiv = area.querySelector('.ai-response');
        const loadingDiv = area.querySelector('.ai-loading');
        const textDiv = area.querySelector('.ai-text');
        
        btn.style.display = 'none';
        responseDiv.style.display = 'block';
        loadingDiv.style.display = 'flex';
        textDiv.textContent = '';
        
        try {
          const response = await fetch('http://127.0.0.1:8080/api/ai/explain-alert', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(alert)
          });
          
          if (!response.ok) throw new Error(await response.text());
          
          const explanation = await response.json();
          loadingDiv.style.display = 'none';
          textDiv.textContent = explanation;
        } catch (error) {
          loadingDiv.style.display = 'none';
          textDiv.innerHTML = `<span style="color: #ff4444;">Error: ${error.message}</span>`;
        }
        return;
      }

      const row = target.closest('.alert-row');
      if (row && !target.classList.contains('view-raw-btn')) {
        const expandableContent = row.nextElementSibling;
        if (expandableContent && expandableContent.classList.contains('expandable-content')) {
          row.classList.toggle('expanded');
          expandableContent.classList.toggle('active');
          const svgElement = row.querySelector('.expand-toggle svg');
          if (svgElement) svgElement.classList.toggle('rotated');
        }
      }

      if (target.classList.contains('view-raw-btn')) {
        const rawLog = target.dataset.rawLog;
        if (rawLogDisplay) rawLogDisplay.textContent = rawLog;
        if (rawLogModal) rawLogModal.style.display = 'block';
      }
    });

    // Close modal logic
    if (closeModalButton) {
      closeModalButton.addEventListener('click', () => {
        rawLogModal.style.display = 'none';
      });
    }

    window.addEventListener('click', (event) => {
      if (event.target === rawLogModal) {
        rawLogModal.style.display = 'none';
      }
    });

    // Initial state
    renderAlerts([]);
  });
</script>