---
---

<section class="performance-section">
  <div class="section-header">
    <div class="section-title">REAL-TIME ANALYSIS & PERFORMANCE METRICS</div>
    <div class="mode-badges">
      <span class="mode-badge active">LIVE</span>
      <span class="mode-badge">STREAMING</span>
    </div>
  </div>

  <table class="metrics-table">
    <thead>
      <tr>
        <th>MODE</th>
        <th>LOGS PROCESSED</th>
        <th>TIME (MS)</th>
        <th>LOGS/SEC</th>
        <th>ALERTS</th>
      </tr>
    </thead>
    <tbody>
      <tr class="mode-row" id="sequential-row">
        <td class="mode-cell">
          <div class="mode-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
          </div>
          <div class="mode-info">
            <h4>Sequential</h4>
            <span>Standard processing</span>
          </div>
        </td>
        <td class="value-cell" data-metric="logsProcessed">0</td>
        <td class="value-cell" data-metric="timeTaken">0<span class="unit">ms</span></td>
        <td class="value-cell" data-metric="logsPerSec">0<span class="unit">/sec</span></td>
        <td class="alert-cell">
          <div class="alert-count">0</div>
          <span class="alert-text">No alerts</span>
        </td>
      </tr>
      <tr class="progress-row">
        <td colspan="5">
          <div class="progress-bar-container">
            <div class="progress-bar" id="sequential-progress" style="width: 0%;"></div>
          </div>
        </td>
      </tr>
      <tr class="mode-row" id="parallel-row">
        <td class="mode-cell">
          <div class="mode-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-purple)" stroke-width="2">
              <polygon points="13 19 22 12 13 5 13 19"></polygon>
              <polygon points="2 19 11 12 2 5 2 19"></polygon>
            </svg>
          </div>
          <div class="mode-info">
            <h4>Parallel</h4>
            <span>Multi-threaded</span>
          </div>
        </td>
        <td class="value-cell" data-metric="logsProcessed">0</td>
        <td class="value-cell" data-metric="timeTaken">0<span class="unit">ms</span></td>
        <td class="value-cell" data-metric="logsPerSec">0<span class="unit">/sec</span></td>
        <td class="alert-cell">
          <div class="alert-count">0</div>
          <span class="alert-text">No alerts</span>
        </td>
      </tr>
      <tr class="progress-row">
        <td colspan="5">
          <div class="progress-bar-container">
            <div class="progress-bar" id="parallel-progress" style="width: 0%;"></div>
          </div>
        </td>
      </tr>
      <tr class="mode-row" id="distributed-row">
        <td class="mode-cell">
          <div class="mode-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="2">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
          </div>
          <div class="mode-info">
            <h4>Distributed</h4>
            <span>Cluster mode</span>
          </div>
        </td>
        <td class="value-cell" data-metric="logsProcessed">0</td>
        <td class="value-cell" data-metric="timeTaken">0<span class="unit">ms</span></td>
        <td class="value-cell" data-metric="logsPerSec">0<span class="unit">/sec</span></td>
        <td class="alert-cell">
          <div class="alert-count">0</div>
          <span class="alert-text">No alerts</span>
        </td>
      </tr>
      <tr class="progress-row">
        <td colspan="5">
          <div class="progress-bar-container">
            <div class="progress-bar" id="distributed-progress" style="width: 0%;"></div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="action-buttons">
    <button class="action-btn secondary" id="run-sequential-btn">
      <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </svg>
      Run Sequential
    </button>
    <button class="action-btn secondary" id="run-parallel-btn">
      <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="13 19 22 12 13 5 13 19"></polygon>
        <polygon points="2 19 11 12 2 5 2 19"></polygon>
      </svg>
      Run Parallel
    </button>
    <button class="action-btn secondary" id="run-distributed-btn">
      <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
      </svg>
      Run Distributed
    </button>
    <button class="action-btn primary" id="ai-explanation-btn">
      <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5a3 3 0 1 0-3 3"></path>
        <path d="M12 5a3 3 0 1 1 3 3"></path>
        <path d="M12 7a6 6 0 0 1 6 6v3a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2v-1a2 2 0 0 0-2-2 1 1 0 0 1-1-1V7a3 3 0 0 0-3-3H8a3 3 0 0 0-3 3v1a1 1 0 0 1-1 1 2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2v-3a6 6 0 0 1 6-6z"></path>
      </svg>
      Get AI Explanation
    </button>
    <input type="file" id="log-file-upload" accept=".log,.txt" style="display: none;"/>
    <button class="action-btn primary" id="upload-log-btn">
      <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      Upload Log File
    </button>
  </div>

  <div id="file-info-badge" class="file-info-badge" style="display: none;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2">
      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
      <polyline points="13 2 13 9 20 9"></polyline>
    </svg>
    <span id="uploaded-filename">No file selected</span>
    <span class="file-size" id="uploaded-filesize"></span>
  </div>
</section>

<div class="uploaded-content-section" id="uploaded-content-section" style="display: none; margin-top: 25px;">
  <div class="section-title" style="font-size: 14px; margin-bottom: 10px; color: var(--text-secondary);">UPLOADED LOG CONTENT</div>
  <pre id="log-content-display" class="log-content-display"></pre>
</div>



<script>
  document.addEventListener('DOMContentLoaded', () => {
    const runSequentialBtn = document.getElementById('run-sequential-btn');
    const runParallelBtn = document.getElementById('run-parallel-btn');
    const runDistributedBtn = document.getElementById('run-distributed-btn');
    const aiExplanationBtn = document.getElementById('ai-explanation-btn');
    const logFileUpload = document.getElementById('log-file-upload');
    const uploadLogBtn = document.getElementById('upload-log-btn');

    let logData = [];
    let processedLogCount = 0;
    let totalLogEntries = 0;
    let totalActiveAlerts = 0; // New variable to track total active alerts

    // Function to dispatch total active alerts
    const dispatchTotalAlerts = (count) => {
      const event = new CustomEvent('totalAlertsUpdated', { detail: { totalAlerts: count } });
      document.dispatchEvent(event);
    };

    // Fetch log data from public/data/example_log.txt
    async function fetchLogData() {
      try {
        const response = await fetch('/data/example_log.txt');
        const text = await response.text();
        logData = text.split('\n').filter(line => line.trim() !== '');
        totalLogEntries = logData.length;
        console.log(`Loaded ${totalLogEntries} log entries.`);
      } catch (error) {
        console.error('Error fetching log data:', error);
      }
    }

    // Handle file upload
    uploadLogBtn.addEventListener('click', () => {
      logFileUpload.click(); // Trigger the hidden file input
    });

    logFileUpload.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        console.log('Selected file:', file.name);
        const reader = new FileReader();
        reader.onload = async (e) => {
          const logContent = e.target.result;
          
          // Update global logData so subsequent "Run" buttons use this data
          logData = logContent.split('\n').filter(line => line.trim() !== '');
          totalLogEntries = logData.length;
          console.log(`Updated logData with ${totalLogEntries} entries from upload.`);

          // Show file info badge
          const fileBadge = document.getElementById('file-info-badge');
          const fileNameSpan = document.getElementById('uploaded-filename');
          const fileSizeSpan = document.getElementById('uploaded-filesize');
          if (fileBadge && fileNameSpan && fileSizeSpan) {
            fileNameSpan.textContent = file.name;
            const sizeInKb = (file.size / 1024).toFixed(2);
            fileSizeSpan.textContent = `(${sizeInKb} KB)`;
            fileBadge.style.display = 'flex';
          }

          // Display the content
          const contentDisplay = document.getElementById('log-content-display');
          const contentSection = document.getElementById('uploaded-content-section');
          if (contentDisplay && contentSection) {
            contentDisplay.textContent = logContent;
            contentSection.style.display = 'block';
          }

          try {
            const response = await fetch('/api/logs/upload', {
              method: 'POST',
              headers: {
                'Content-Type': 'text/plain',
              },
              body: logContent,
            });
            if (response.ok) {
              const metrics = await response.json(); // Response is a Metrics object
              console.log('Log file uploaded to server successfully.');
              
              // alert(`File ${file.name} uploaded. Press a run button to start analysis.`);
              
              // We don't update metrics table here anymore, wait for button press
            } else {
              const errorText = await response.text();
              console.error('Upload failed:', response.status, errorText);
              alert(`Failed to upload file: ${errorText}`);
            }
          } catch (error) {
            console.error('Error during file upload:', error);
            alert('Error during file upload.');
          }
        };
        reader.readAsText(file);
      }
    });

    // Helper function
    const getRandomNumber = (min, max) => {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    };

    // Animate number changes
    const animateNumberChange = (element, start, end, unit = '', duration = 500) => {
      const range = end - start;
      let current = start;
      const increment = end > start ? 1 : -1;
      const stepTime = Math.abs(Math.floor(duration / range));
      const timer = setInterval(() => {
        current += increment;
        element.textContent = current.toLocaleString() + unit;
        if (current === end) {
          clearInterval(timer);
        }
      }, stepTime);
    };

    // Reset metrics and progress bars
    const resetMetrics = (mode) => {
      const rowMap = {
        'Sequential': document.getElementById('sequential-row'),
        'Parallel': document.getElementById('parallel-row'),
        'Distributed': document.getElementById('distributed-row')
      };
      const progressMap = {
        'Sequential': document.getElementById('sequential-progress'),
        'Parallel': document.getElementById('parallel-progress'),
        'Distributed': document.getElementById('distributed-progress')
      };

      const row = rowMap[mode];
      const progressBar = progressMap[mode];

      if (row) {
        row.querySelector('[data-metric="logsProcessed"]').textContent = '0';
        row.querySelector('[data-metric="timeTaken"]').innerHTML = '0<span class="unit">ms</span>';
        row.querySelector('[data-metric="logsPerSec"]').innerHTML = '0<span class="unit">/sec</span>';
        row.querySelector('.alert-count').textContent = '0';
        row.querySelector('.alert-text').textContent = 'No alerts';
      }
      if (progressBar) {
        progressBar.style.width = '0%';
      }
    };

    let lastRunMetrics = null;

    // Simulate processing
    const simulateProcessing = async (mode) => {
      resetMetrics(mode); // Reset metrics for the current mode before starting

      const buttons = {
        'Sequential': runSequentialBtn,
        'Parallel': runParallelBtn,
        'Distributed': runDistributedBtn
      };

      const button = buttons[mode];
      if (!button) return;

      const originalText = button.innerHTML;
      button.innerHTML = `
        <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
        </svg>
        Processing...
      `;
      button.disabled = true;

      const startTime = performance.now();
      
      try {
        const logEntriesForBackend = logData.map(line => ({
          timestamp: new Date().toISOString(), // Use ISO string for timestamp
          raw_log: line // Changed from 'details' to 'raw_log' to match backend struct
        }));

        const response = await fetch(`/api/analyze/${mode.toLowerCase()}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(logEntriesForBackend),
        });

        if (response.ok) {
          const metrics = await response.json(); // Response is a Metrics object
          const alerts = metrics.alerts_generated;
          console.log(`${mode} processing successful, alerts:`, alerts);
          
          const timeTaken = metrics.execution_time_ms;
          updateMetrics(mode, logData.length, timeTaken, alerts.length, 100, metrics.logs_per_second);

          // Dispatch alerts to other components
          const alertsEvent = new CustomEvent('alertsDetected', { detail: { alerts: alerts } });
          document.dispatchEvent(alertsEvent);
          
          // Also update the total active alerts in header
          dispatchTotalAlerts(alerts.length);

          // Store metrics for AI explanation
          lastRunMetrics = {
              total_logs_processed: logData.length,
              execution_time_ms: timeTaken,
              logs_per_second: metrics.logs_per_second,
              alerts_generated: alerts,
              mode: mode
          };
        } else {
          const errorText = await response.text();
          console.error(`${mode} processing failed:`, response.status, errorText);
          alert(`${mode} processing failed: ${errorText}`);
        }
      } catch (error) {
        console.error(`Error during ${mode} processing:`, error);
        alert(`Error during ${mode} processing.`);
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    };

    // AI Explanation
    const showAIExplanation = async () => {
      if (!lastRunMetrics) {
        alert("Please run an analysis first to generate metrics for explanation.");
        return;
      }

      aiExplanationBtn.innerHTML = `
        <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
        </svg>
        Generating Explanation...
      `;
      aiExplanationBtn.disabled = true;

      try {
        // Send a list of metrics as expected by backend/python script
        const response = await fetch('/api/ai/explain', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify([lastRunMetrics]),
        });

        if (response.ok) {
          const explanation = await response.json();
          alert('AI Analysis Report:\n\n' + explanation.explanation);
        } else {
          const errorText = await response.text();
          console.error('AI Explanation failed:', response.status, errorText);
          alert(`AI Explanation failed: ${errorText}`);
        }
      } catch (error) {
        console.error('Error during AI Explanation:', error);
        alert('Error during AI Explanation.');
      } finally {
        aiExplanationBtn.innerHTML = `
          <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5a3 3 0 1 0-3 3"></path>
            <path d="M12 5a3 3 0 1 1 3 3"></path>
            <path d="M12 7a6 6 0 0 1 6 6v3a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2v-1a2 2 0 0 0-2-2 1 1 0 0 1-1-1V7a3 3 0 0 0-3-3H8a3 3 0 0 0-3 3v1a1 1 0 0 1-1 1 2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2v-3a6 6 0 0 1 6-6z"></path>
          </svg>
          Get AI Explanation
        `;
        aiExplanationBtn.disabled = false;
      }
    };

    // Update metrics function
    const updateMetrics = (mode, count, time, alerts, progress, logsPerSecFromBackend = null) => {
      const rowMap = {
        'Sequential': document.getElementById('sequential-row'),
        'Parallel': document.getElementById('parallel-row'),
        'Distributed': document.getElementById('distributed-row')
      };
      const progressMap = {
        'Sequential': document.getElementById('sequential-progress'),
        'Parallel': document.getElementById('parallel-progress'),
        'Distributed': document.getElementById('distributed-progress')
      };

      const row = rowMap[mode];
      const progressBar = progressMap[mode];

      if (row) {
        // animateNumberChange(row.querySelector('[data-metric="logsProcessed"]'), 0, count);
        row.querySelector('[data-metric="logsProcessed"]').textContent = count.toLocaleString();
        row.querySelector('[data-metric="timeTaken"]').innerHTML = `${Number(time).toFixed(2)}<span class="unit">ms</span>`;
        
        let logsPerSec = logsPerSecFromBackend;
        if (logsPerSec === null) {
            if (time > 0) {
                logsPerSec = (count / time) * 1000;
            } else {
                logsPerSec = 0;
            }
        }
        row.querySelector('[data-metric="logsPerSec"]').innerHTML = `${Math.floor(logsPerSec).toLocaleString()}<span class="unit">/sec</span>`;
        
        row.querySelector('.alert-count').textContent = alerts;
        row.querySelector('.alert-text').textContent = alerts === 0 ? 'No alerts' : `${alerts} alerts detected`;
      }
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
      }
    };

    // Event listeners
    if (runSequentialBtn) runSequentialBtn.addEventListener('click', () => simulateProcessing('Sequential'));
    if (runParallelBtn) runParallelBtn.addEventListener('click', () => simulateProcessing('Parallel'));
    if (runDistributedBtn) runDistributedBtn.addEventListener('click', () => simulateProcessing('Distributed'));
    if (aiExplanationBtn) aiExplanationBtn.addEventListener('click', showAIExplanation);

    // Initial fetch of log data
    fetchLogData();
    // Make alert cells clickable to navigate to Alerts tab
    document.querySelectorAll('.mode-row .alert-cell').forEach(cell => {
      cell.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('navigateToAlerts'));
      });
    });
  });
</script>

<style>
  /* Styles for RealtimeAnalysis component */
  .performance-section {
    background-color: var(--card-bg);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }

  .section-title {
    font-size: 18px;
    font-weight: 600;
  }

  .mode-badges {
    display: flex;
    gap: 10px;
  }

  .mode-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .mode-badge.active {
    background-color: rgba(0, 123, 255, 0.1);
    border-color: var(--accent-blue);
    color: var(--accent-blue);
  }

  .mode-badge:hover:not(.active) {
    background-color: rgba(255, 255, 255, 0.08);
  }

  .metrics-table {
    width: 100%;
    border-collapse: collapse;
  }

  .metrics-table th {
    text-align: left;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.03);
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
  }

  .metrics-table td {
    padding: 20px 15px;
    border-bottom: 1px solid var(--border-color);
  }

  .metrics-table tr:last-child td {
    border-bottom: none;
  }

  .mode-cell {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .mode-icon {
    width: 32px;
    height: 32px;
    background-color: rgba(0, 123, 255, 0.1);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .mode-info h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 3px;
  }

  .mode-info span {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .value-cell {
    font-size: 18px;
    font-weight: 700;
  }

  .unit {
    font-size: 12px;
    color: var(--text-secondary);
    margin-left: 3px;
  }

  .alert-cell {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 8px !important;
    border-radius: 6px;
  }

  .alert-cell:hover {
    background-color: rgba(255, 68, 68, 0.1);
    transform: translateX(5px);
  }

  .alert-count {
    background-color: var(--accent-red);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
  }

  .no-alerts {
    color: var(--text-secondary);
    font-size: 12px;
  }

  .action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
  }

  .action-btn {
    padding: 12px 24px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--card-bg);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
  }

  .action-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .action-btn.primary {
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    border: none;
  }

  .action-btn.secondary {
    background-color: rgba(255, 255, 255, 0.05);
  }

  .action-btn-icon {
    width: 18px;
    height: 18px;
  }

  .progress-bar-container {
    width: 100%;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    height: 8px;
    overflow: hidden;
    margin-top: 10px;
  }

  .progress-bar {
    height: 100%;
    background-color: var(--accent-blue);
    width: 0%;
    transition: width 0.3s ease-out;
  }

  .file-info-badge {
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    padding: 10px 15px;
    border-radius: 8px;
    margin-top: 15px;
    font-size: 13px;
    color: var(--text-primary);
  }

  .file-size {
    color: var(--text-secondary);
    font-size: 11px;
    margin-left: 5px;
  }

  .mode-row td {
    padding-bottom: 5px;
  }

  .progress-row td {
    padding-top: 0;
    padding-bottom: 20px;
  }

  .subsection-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--text-primary);
  }

  .log-content-display {
    background-color: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: var(--text-secondary);
    white-space: pre-wrap;
    line-height: 1.5;
  }
</style>
